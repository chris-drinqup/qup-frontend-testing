#!/usr/bin/env python3
"""
QUP User Management CLI Tool
Manage users via command line and validate API functionality
"""

import os
import sys
import json
import bcrypt
import hashlib
import requests
import argparse
from pathlib import Path
from dotenv import load_dotenv

# Load environment
load_dotenv()

class QUPUserManager:
    def __init__(self):
        self.api_base = os.environ.get('QUP_API_BASE', 'https://qupcore-supercode-692478335867.us-central1.run.app')
        self.dev_api_key = os.environ.get('DEV_API_KEY', 'UwCNmn3I0XxmJ15nRxu6dkPIqAz46dxOb4ljz0-SRlc')
        
        # Load auth config from environment
        self.auth_config = {'users': {}, 'api_keys': {}}
        self._load_auth_config()
        
    def _load_auth_config(self):
        """Load authentication configuration from environment"""
        # Load admin user
        admin_hash = os.environ.get('ADMIN_PASSWORD_HASH_B64', '')
        if admin_hash:
            try:
                import base64
                admin_hash = base64.b64decode(admin_hash).decode('utf-8')
            except:
                admin_hash = os.environ.get('ADMIN_PASSWORD_HASH', '')
        else:
            admin_hash = os.environ.get('ADMIN_PASSWORD_HASH', '')
            
        if admin_hash:
            self.auth_config['users']['admin'] = {
                'password_hash': admin_hash,
                'hash_type': 'bcrypt',
                'role': 'admin',
                'active': True
            }
            
        # Add API key
        self.auth_config['api_keys'][self.dev_api_key] = {
            'name': 'developer_key',
            'permissions': ['queue:read', 'queue:write'],
            'active': True
        }
    
    def hash_password(self, password):
        """Hash password using bcrypt"""
        salt = bcrypt.gensalt()
        return bcrypt.hashpw(password.encode('utf-8'), salt).decode('utf-8')
    
    def verify_password(self, password, hash_str):
        """Verify password against hash"""
        try:
            return bcrypt.checkpw(password.encode('utf-8'), hash_str.encode('utf-8'))
        except:
            # Fallback to SHA256
            return hashlib.sha256(password.encode()).hexdigest() == hash_str
    
    def list_users(self):
        """List all configured users"""
        print("\nüîê CONFIGURED USERS")
        print("=" * 50)
        
        if not self.auth_config['users']:
            print("‚ùå No users configured")
            return
            
        for username, user_info in self.auth_config['users'].items():
            status = "‚úÖ Active" if user_info.get('active', True) else "‚ùå Inactive"
            role = user_info.get('role', 'user')
            hash_type = user_info.get('hash_type', 'sha256')
            hash_preview = user_info.get('password_hash', '')[:20] + '...'
            
            print(f"üë§ {username}")
            print(f"   Role: {role}")
            print(f"   Status: {status}")
            print(f"   Hash Type: {hash_type}")
            print(f"   Hash: {hash_preview}")
            print()
    
    def add_user(self, username, password, role='user'):
        """Add a new user"""
        if username in self.auth_config['users']:
            print(f"‚ùå User '{username}' already exists")
            return False
            
        password_hash = self.hash_password(password)
        
        self.auth_config['users'][username] = {
            'password_hash': password_hash,
            'hash_type': 'bcrypt',
            'role': role,
            'active': True
        }
        
        print(f"‚úÖ User '{username}' created with role '{role}'")
        print(f"   Password hash: {password_hash[:30]}...")
        return True
    
    def delete_user(self, username):
        """Delete a user"""
        if username not in self.auth_config['users']:
            print(f"‚ùå User '{username}' not found")
            return False
            
        if username == 'admin':
            print("‚ùå Cannot delete admin user")
            return False
            
        del self.auth_config['users'][username]
        print(f"‚úÖ User '{username}' deleted")
        return True
    
    def test_login(self, username, password):
        """Test user login"""
        print(f"\nüîç TESTING LOGIN FOR: {username}")
        print("=" * 50)
        
        if username not in self.auth_config['users']:
            print(f"‚ùå User '{username}' not found in local config")
            return False
            
        user_info = self.auth_config['users'][username]
        stored_hash = user_info['password_hash']
        hash_type = user_info.get('hash_type', 'sha256')
        
        print(f"Hash type: {hash_type}")
        print(f"Stored hash: {stored_hash[:30]}...")
        
        # Test local verification
        local_valid = self.verify_password(password, stored_hash)
        print(f"Local verification: {'‚úÖ PASS' if local_valid else '‚ùå FAIL'}")
        
        # Test API login
        try:
            response = requests.post(f'{self.api_base}/api/v1/auth/login', 
                                   json={'username': username, 'password': password},
                                   timeout=10)
            
            print(f"API response status: {response.status_code}")
            
            if response.status_code == 200:
                data = response.json()
                print(f"‚úÖ API LOGIN SUCCESS")
                print(f"   Token type: {data.get('token_type', 'N/A')}")
                print(f"   User type: {data.get('user_type', 'N/A')}")
                print(f"   Token preview: {data.get('access_token', '')[:50]}...")
                return True
            else:
                print(f"‚ùå API LOGIN FAILED")
                try:
                    error_data = response.json()
                    print(f"   Error: {error_data.get('error', 'Unknown error')}")
                except:
                    print(f"   Raw response: {response.text[:200]}")
                return False
                
        except Exception as e:
            print(f"‚ùå API CONNECTION ERROR: {e}")
            return False
    
    def test_api_endpoints(self, username=None, password=None):
        """Test various API endpoints"""
        print(f"\nüß™ TESTING API ENDPOINTS")
        print("=" * 50)
        
        # Test health endpoint
        try:
            response = requests.get(f'{self.api_base}/health', timeout=10)
            print(f"Health endpoint: {'‚úÖ OK' if response.status_code == 200 else '‚ùå FAIL'} ({response.status_code})")
        except Exception as e:
            print(f"Health endpoint: ‚ùå ERROR - {e}")
        
        # Test auth debug
        try:
            response = requests.get(f'{self.api_base}/debug/auth', timeout=10)
            if response.status_code == 200:
                data = response.json()
                print(f"Auth debug: ‚úÖ OK")
                print(f"   Admin user exists: {data.get('admin_user_exists', False)}")
                print(f"   Admin hash set: {data.get('admin_hash_set', False)}")
                print(f"   Users configured: {data.get('auth_config_users', [])}")
            else:
                print(f"Auth debug: ‚ùå FAIL ({response.status_code})")
        except Exception as e:
            print(f"Auth debug: ‚ùå ERROR - {e}")
        
        # Test queue list with API key
        try:
            headers = {'X-API-Key': self.dev_api_key}
            response = requests.get(f'{self.api_base}/api/v1/queue/list', headers=headers, timeout=10)
            print(f"Queue list (API key): {'‚úÖ OK' if response.status_code == 200 else '‚ùå FAIL'} ({response.status_code})")
        except Exception as e:
            print(f"Queue list (API key): ‚ùå ERROR - {e}")
        
        # Test with JWT token if credentials provided
        if username and password:
            try:
                login_response = requests.post(f'{self.api_base}/api/v1/auth/login', 
                                             json={'username': username, 'password': password},
                                             timeout=10)
                if login_response.status_code == 200:
                    token = login_response.json().get('access_token')
                    headers = {'Authorization': f'Bearer {token}'}
                    
                    # Test users endpoint
                    response = requests.get(f'{self.api_base}/api/users', headers=headers, timeout=10)
                    print(f"Users endpoint (JWT): {'‚úÖ OK' if response.status_code == 200 else '‚ùå FAIL'} ({response.status_code})")
                    
                    if response.status_code == 200:
                        users = response.json().get('users', [])
                        print(f"   Found {len(users)} users: {[u.get('username') for u in users]}")
                        
                else:
                    print(f"JWT test: ‚ùå FAIL - Could not get token")
            except Exception as e:
                print(f"JWT test: ‚ùå ERROR - {e}")
    
    def show_env_info(self):
        """Show environment configuration"""
        print(f"\nüåç ENVIRONMENT CONFIGURATION")
        print("=" * 50)
        
        env_vars = [
            'QUP_API_BASE',
            'DEV_API_KEY', 
            'ADMIN_PASSWORD_HASH',
            'ADMIN_PASSWORD_HASH_B64',
            'JWT_SECRET_KEY',
            'SUPABASE_URL',
            'SUPABASE_KEY'
        ]
        
        for var in env_vars:
            value = os.environ.get(var, 'NOT SET')
            if var in ['ADMIN_PASSWORD_HASH', 'ADMIN_PASSWORD_HASH_B64', 'JWT_SECRET_KEY', 'SUPABASE_KEY']:
                display_value = f"{value[:20]}..." if value != 'NOT SET' else 'NOT SET'
            else:
                display_value = value
            print(f"{var}: {display_value}")
        
        print(f"\nAPI Base URL: {self.api_base}")
        print(f"Working Directory: {os.getcwd()}")

def main():
    parser = argparse.ArgumentParser(description='QUP User Management CLI')
    parser.add_argument('command', choices=['list', 'add', 'delete', 'test-login', 'test-api', 'env-info'], 
                       help='Command to execute')
    parser.add_argument('--username', '-u', help='Username')
    parser.add_argument('--password', '-p', help='Password')
    parser.add_argument('--role', '-r', default='user', choices=['user', 'admin', 'server'], help='User role')
    
    args = parser.parse_args()
    
    manager = QUPUserManager()
    
    if args.command == 'list':
        manager.list_users()
        
    elif args.command == 'add':
        if not args.username or not args.password:
            print("‚ùå Username and password required for adding user")
            sys.exit(1)
        manager.add_user(args.username, args.password, args.role)
        
    elif args.command == 'delete':
        if not args.username:
            print("‚ùå Username required for deleting user")
            sys.exit(1)
        manager.delete_user(args.username)
        
    elif args.command == 'test-login':
        if not args.username or not args.password:
            print("‚ùå Username and password required for testing login")
            sys.exit(1)
        manager.test_login(args.username, args.password)
        
    elif args.command == 'test-api':
        manager.test_api_endpoints(args.username, args.password)
        
    elif args.command == 'env-info':
        manager.show_env_info()

if __name__ == '__main__':
    main()
