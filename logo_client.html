<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUP - Order Here</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #4c63d2;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a3e;
            --bg-card: #262654;
            --text-primary: #ffffff;
            --text-secondary: #a5a5c9;
            --border: #3a3a6b;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 40px var(--shadow);
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .logo-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .company-logo {
            height: 50px;
            width: auto;
            border-radius: 8px;
            object-fit: contain;
        }

        .logo {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .connection-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: var(--bg-card);
        }

        .btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #dc2626);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover::before {
            width: 0;
            height: 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        .order-status {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: left;
        }

        .order-status h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .status-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .pickup-code {
            background: linear-gradient(45deg, var(--success), #059669);
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: 2px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 20;
        }

        .pickup-code:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
        }

        .screen-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(16, 185, 129, 0.9);
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            animation: flashEffect 0.8s ease-in-out;
        }

        @keyframes flashEffect {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .countdown {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--warning);
            margin: 10px 0;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin: 15px 0;
            font-weight: 600;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.15);
            color: var(--info);
            border: 1px solid var(--info);
        }

        .user-info {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-email {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .logout-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .hidden {
            display: none;
        }

        /* Logo Rain Animation System */
        .logo-rain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }

        .rain-logo {
            position: absolute;
            width: 30px;
            height: 30px;
            opacity: 0.3;
            animation: rainFall linear infinite;
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            transform: rotate(15deg);
        }

        @keyframes rainFall {
            from {
                top: -40px;
                transform: rotate(0deg) scale(1);
            }
            50% {
                transform: rotate(180deg) scale(1.2);
            }
            to {
                top: 100vh;
                transform: rotate(360deg) scale(0.8);
            }
        }

        .rain-logo:nth-child(odd) {
            animation-direction: reverse;
        }

        .rain-logo:nth-child(3n) {
            animation-duration: 4s;
        }

        .rain-logo:nth-child(3n+1) {
            animation-duration: 6s;
        }

        .rain-logo:nth-child(3n+2) {
            animation-duration: 5s;
        }

        /* Anti-screenshot measures */
        .pickup-section-protected {
            position: relative;
        }

        .pickup-section-protected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, transparent 30%, rgba(255,255,255,0.1) 31%, rgba(255,255,255,0.1) 32%, transparent 33%);
            background-size: 20px 20px;
            animation: backgroundShimmer 2s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes backgroundShimmer {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 30px 25px;
            }

            .logo {
                font-size: 2.5rem;
            }

            .company-logo {
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Logo Rain Container -->
    <div id="logoRain" class="logo-rain"></div>

    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="card">
            <div class="logo-header">
                <img id="loginLogo" class="company-logo" src="" alt="Logo" style="display: none;">
                <div class="logo">QUP</div>
            </div>
            <div class="subtitle">Sign in to place your order</div>

            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" class="form-control" placeholder="Enter your email">
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password">
            </div>

            <button class="btn btn-primary" onclick="handleLogin()">
                <span id="loginText">Sign In</span>
                <div id="loginLoading" class="loading hidden"></div>
            </button>

            <div id="loginError" class="alert alert-error hidden">
                Login failed. Please check your credentials.
            </div>

            <div style="margin-top: 20px; font-size: 0.9rem; color: var(--text-secondary);">
                Need an account? Contact your administrator.<br>
                <button type="button" style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; margin-top: 10px;" onclick="skipAuth()">
                    Skip Login (Test Mode)
                </button>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="appScreen" class="card hidden">
            <div class="logo-header">
                <img id="appLogo" class="company-logo" src="" alt="Logo" style="display: none;">
                <div class="logo">QUP</div>
            </div>
            <div class="subtitle">Place Your Order</div>

            <div class="user-info">
                <span id="userEmail" class="user-email"></span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>

            <div class="connection-status" id="connectionStatus">
                <div class="connection-dot"></div>
                <span>Connecting...</span>
            </div>

            <!-- Order Form -->
            <div id="orderForm">
                <div class="form-group">
                    <label for="customerName">Your Name:</label>
                    <input type="text" id="customerName" class="form-control"
                           placeholder="Enter your name (e.g., John Smith)">
                </div>

                <div class="form-group">
                    <label for="orderDescription">What would you like to order?</label>
                    <input type="text" id="orderDescription" class="form-control"
                           placeholder="e.g., Large coffee with milk, no sugar">
                </div>

                <button class="btn btn-primary" onclick="placeOrder()">
                    <span id="orderButtonText">Place Order</span>
                    <div id="orderLoading" class="loading hidden"></div>
                </button>
            </div>

            <!-- Order Status -->
            <div id="orderStatus" class="order-status hidden">
                <h3>Your Order</h3>
                <div class="status-item">
                    <span class="status-label">Customer:</span>
                    <span class="status-value" id="orderCustomerName">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Order:</span>
                    <span class="status-value" id="orderDetails">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Status:</span>
                    <span class="status-value" id="orderCurrentStatus">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Est. Wait:</span>
                    <span class="status-value countdown" id="orderWaitTime">-</span>
                </div>
            </div>

            <!-- Pickup Code Display with Protection -->
            <div id="pickupSection" class="pickup-section-protected hidden">
                <div class="alert alert-success">
                    Your order is ready for PiQUP!
                </div>
                <div class="pickup-code" id="pickupCode" onclick="flashScreen()">----</div>
                <div style="color: var(--text-secondary); margin-bottom: 20px;">
                    Show this code to the barista
                </div>
            </div>

            <!-- Order Complete -->
            <div id="completeSection" class="hidden">
                <div class="alert alert-success">
                    Order completed! Thank you for using QUP.
                </div>
                <button class="btn btn-primary" onclick="startNewOrder()">
                    Place Another Order
                </button>
            </div>

            <div id="alerts"></div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://eorhgophbjjbiguvkygo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvcmhnb3BoYmpqYmlndXZreWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MjMyMjUsImV4cCI6MjA2NDM5OTIyNX0.fV_6TFXfjDVusTeknF_LAGjxw7BfTZtoQ0helbm5mwo';
        const API_BASE = 'https://qupcore-supercode-692478335867.us-central1.run.app';

        // Initialize Supabase
        let supabase = null;

        // Global state
        let socket = null;
        let currentUser = null;
        let currentOrder = null;
        let developerKey = null;
        let waitTimeInterval = null;
        let estimatedCompletionTime = null;
        let orderStatusInterval = null;
        let logoRainInterval = null;
        let currentLogo = null;
        let logoSettings = null;

        function initializeSupabase() {
            try {
                if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL' ||
                    !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                    console.error('Supabase configuration missing. Please update SUPABASE_URL and SUPABASE_ANON_KEY');
                    showAlert('Supabase configuration missing. Please contact administrator.', 'error');
                    return false;
                }

                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized');
                return true;
            } catch (error) {
                console.error('Supabase initialization failed:', error);
                showAlert('Failed to initialize authentication system.', 'error');
                return false;
            }
        }

        // Initialize app
        async function init() {
            console.log('QUP Client initializing...');

            // Initialize Supabase first
            if (!initializeSupabase()) {
                showLogin();
                return;
            }

            // Load logo and settings
            await loadCompanyAssets();

            // Check if user is already logged in
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    showApp(user);
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Failed to check user session:', error);
                showLogin();
            }
        }

        // Load company logo and settings
        async function loadCompanyAssets() {
            try {
                // Load current logo
                const { data: logoData, error: logoError } = await supabase
                    .from('company_logos')
                    .select('*')
                    .eq('is_active', true)
                    .order('uploaded_at', { ascending: false })
                    .limit(1);

                if (!logoError && logoData && logoData.length > 0) {
                    currentLogo = logoData[0];
                    updateLogoDisplays();
                }

                // Load logo settings
                const { data: settingsData, error: settingsError } = await supabase
                    .from('logo_settings')
                    .select('*')
                    .limit(1);

                if (!settingsError && settingsData && settingsData.length > 0) {
                    logoSettings = settingsData[0];
                } else {
                    // Default settings
                    logoSettings = {
                        show_client: true,
                        client_size: 50,
                        enable_rain: true,
                        rain_intensity: 3,
                        rain_opacity: 30
                    };
                }

                console.log('Company assets loaded:', { currentLogo: !!currentLogo, logoSettings });

            } catch (error) {
                console.error('Failed to load company assets:', error);
                // Use defaults
                logoSettings = {
                    show_client: true,
                    client_size: 50,
                    enable_rain: true,
                    rain_intensity: 3,
                    rain_opacity: 30
                };
            }
        }

        function updateLogoDisplays() {
            if (!currentLogo || !logoSettings || !logoSettings.show_client) {
                return;
            }

            const loginLogo = document.getElementById('loginLogo');
            const appLogo = document.getElementById('appLogo');

            if (loginLogo && appLogo) {
                const logoUrl = currentLogo.logo_url;
                const logoSize = logoSettings.client_size || 50;

                loginLogo.src = logoUrl;
                loginLogo.style.height = logoSize + 'px';
                loginLogo.style.display = 'block';

                appLogo.src = logoUrl;
                appLogo.style.height = logoSize + 'px';
                appLogo.style.display = 'block';

                console.log('Logo displays updated');
            }
        }

        // Logo Rain System
        function startLogoRain() {
            if (!currentLogo || !logoSettings || !logoSettings.enable_rain) {
                return;
            }

            const rainContainer = document.getElementById('logoRain');
            const rainIntensity = logoSettings.rain_intensity || 3;
            const rainOpacity = (logoSettings.rain_opacity || 30) / 100;

            logoRainInterval = setInterval(() => {
                createRainLogo(rainContainer, rainOpacity);
            }, 1000 / rainIntensity);

            console.log('Logo rain started');
        }

        function createRainLogo(container, opacity) {
            if (!currentLogo) return;

            const logo = document.createElement('img');
            logo.src = currentLogo.logo_url;
            logo.className = 'rain-logo';
            logo.style.left = Math.random() * window.innerWidth + 'px';
            logo.style.opacity = opacity;
            logo.style.animationDuration = (Math.random() * 3 + 3) + 's';
            logo.style.animationDelay = Math.random() * 2 + 's';

            // Prevent drag and context menu
            logo.draggable = false;
            logo.oncontextmenu = () => false;
            logo.onselectstart = () => false;
            logo.ondragstart = () => false;

            container.appendChild(logo);

            // Remove after animation
            setTimeout(() => {
                if (logo.parentNode) {
                    logo.remove();
                }
            }, 8000);
        }

        function stopLogoRain() {
            if (logoRainInterval) {
                clearInterval(logoRainInterval);
                logoRainInterval = null;

                // Clear existing rain logos
                const rainContainer = document.getElementById('logoRain');
                rainContainer.innerHTML = '';

                console.log('Logo rain stopped');
            }
        }

        // Authentication functions
        async function handleLogin() {
            if (!supabase) {
                showAlert('Authentication system not ready. Please refresh the page.', 'error');
                return;
            }

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!email || !password) {
                showAlert('Please enter both email and password', 'error');
                return;
            }

            setLoading('login', true);
            hideElement('loginError');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    throw error;
                }

                console.log('Supabase login successful');
                showApp(data.user);

            } catch (error) {
                console.error('Login failed:', error);
                showElement('loginError');
                showAlert('Login failed: ' + error.message, 'error');
            } finally {
                setLoading('login', false);
            }
        }

        async function logout() {
            if (!supabase) return;

            try {
                await supabase.auth.signOut();
                console.log('Logged out');

                // Cleanup
                stopLogoRain();
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }
                if (waitTimeInterval) {
                    clearInterval(waitTimeInterval);
                    waitTimeInterval = null;
                }
                if (orderStatusInterval) {
                    clearInterval(orderStatusInterval);
                    orderStatusInterval = null;
                }

                currentUser = null;
                currentOrder = null;
                developerKey = null;

                showLogin();

            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // App initialization
        async function showApp(user) {
            currentUser = user;

            hideElement('loginScreen');
            showElement('appScreen');
            document.getElementById('userEmail').textContent = user.email;

            // Pre-fill customer name from email
            const customerNameField = document.getElementById('customerName');
            if (customerNameField && user.email) {
                // Extract name from email (before @)
                const emailUsername = user.email.split('@')[0];
                // Convert underscores/dots to spaces and capitalize
                const suggestedName = emailUsername.replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                customerNameField.value = suggestedName;
            }

            // Get developer key for API access
            await getDeveloperKey();

            // Connect WebSocket
            connectWebSocket();

            console.log('App initialized for:', user.email);
        }

        function showLogin() {
            hideElement('appScreen');
            showElement('loginScreen');
            stopLogoRain();

            // Clear form
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        // Get developer key for API access
        async function getDeveloperKey() {
            try {
                console.log('Getting developer key from:', API_BASE);

                const response = await fetch(`${API_BASE}/api/auth/developer/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'developer',
                        password: 'dev123'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.developer_key) {
                    developerKey = data.developer_key;
                    console.log('Developer key obtained');
                } else {
                    throw new Error(data.error || 'No developer key in response');
                }
            } catch (error) {
                console.error('Developer key error:', error);
                showAlert('Failed to get API access. Please contact administrator.', 'error');
            }
        }

        // WebSocket connection
        function connectWebSocket() {
            try {
                console.log('Connecting to WebSocket at:', API_BASE);

                socket = io(API_BASE, {
                    transports: ['websocket', 'polling'],
                    timeout: 20000,
                    reconnection: true,
                    reconnectionDelay: 2000,
                    reconnectionAttempts: 5,
                    forceNew: true
                });

                socket.on('connect', () => {
                    updateConnectionStatus(true);
                    console.log('WebSocket connected to:', API_BASE);

                    // Subscribe to order updates for this user
                    if (currentOrder) {
                        socket.emit('subscribe', { orderId: currentOrder });
                        console.log('Subscribed to order updates for:', currentOrder);
                    }
                });

                socket.on('disconnect', () => {
                    updateConnectionStatus(false);
                    console.log('WebSocket disconnected');
                });

                socket.on('connect_error', (error) => {
                    console.error('WebSocket connection error:', error);
                    updateConnectionStatus(false);
                });

                socket.on('order_update', (data) => {
                    console.log('Order update received:', data);
                    handleOrderUpdate(data);
                });

                socket.on('subscribed_order_update', (data) => {
                    console.log('Subscribed order update:', data);
                    handleOrderUpdate(data);
                });

                socket.on('queue_update', (data) => {
                    console.log('Queue update received:', data);
                    // Check if our order status changed
                    if (currentOrder && data.queue) {
                        const myOrder = data.queue.find(order => order.id === currentOrder);
                        if (myOrder) {
                            handleMyOrderUpdate(myOrder);
                        }
                    }
                });

                socket.on('error', (error) => {
                    console.error('WebSocket error:', error);
                });

            } catch (error) {
                console.error('WebSocket connection failed:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status connected';
                status.innerHTML = '<div class="connection-dot"></div><span>Connected</span>';
            } else {
                status.className = 'connection-status disconnected';
                status.innerHTML = '<div class="connection-dot"></div><span>Disconnected</span>';
            }
        }

        // Order management
        async function placeOrder() {
            const customerName = document.getElementById('customerName').value.trim();
            const description = document.getElementById('orderDescription').value.trim();

            if (!customerName) {
                showAlert('Please enter your name', 'error');
                return;
            }

            if (!description) {
                showAlert('Please enter your order description', 'error');
                return;
            }

            if (!developerKey) {
                showAlert('API not ready. Please try again.', 'error');
                return;
            }

            setLoading('order', true);

            try {
                const orderId = `${currentUser.email.replace('@', '_').replace('.', '_')}_${Date.now()}`;

                const response = await fetch(`${API_BASE}/api/v1/queue/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': developerKey
                    },
                    body: JSON.stringify({
                        id: orderId,
                        payload: {
                            order: description,
                            customer_email: currentUser.email,
                            customer_name: customerName,
                            items: [{ name: description, quantity: 1 }]
                        },
                        user_id: currentUser.email,
                        priority: 500
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    currentOrder = orderId;

                    // Subscribe to order updates
                    if (socket && socket.connected) {
                        socket.emit('subscribe', { orderId: orderId });
                        console.log('Subscribed to order updates for:', orderId);
                    }

                    // Emit order created event to notify baristas
                    if (socket && socket.connected) {
                        socket.emit('order_created', {
                            orderId: orderId,
                            orderData: {
                                id: orderId,
                                payload: {
                                    order: description,
                                    customer_email: currentUser.email,
                                    customer_name: customerName,
                                    items: [{ name: description, quantity: 1 }]
                                },
                                user_id: currentUser.email,
                                priority: 500
                            }
                        });
                        console.log('Notified baristas of new order');
                    }

                    // Show order status
                    showOrderStatus(customerName, description, data);
                    hideElement('orderForm');

                    // Start periodic order status checking
                    startOrderStatusPolling();

                    console.log('Order placed:', orderId);
                    showAlert('Order placed successfully!', 'success');

                } else {
                    throw new Error(data.error || 'Failed to place order');
                }

            } catch (error) {
                console.error('Order failed:', error);
                showAlert('Order failed: ' + error.message, 'error');
            } finally {
                setLoading('order', false);
            }
        }

        function showOrderStatus(customerName, description, orderData) {
            document.getElementById('orderCustomerName').textContent = customerName;
            document.getElementById('orderDetails').textContent = description;
            document.getElementById('orderCurrentStatus').textContent = 'Waiting in queue';

            // Calculate estimated completion time
            if (orderData.estimated_time) {
                estimatedCompletionTime = new Date(Date.now() + (orderData.estimated_time * 1000));
                startWaitTimeCountdown();
            }

            showElement('orderStatus');
        }

        function startWaitTimeCountdown() {
            if (waitTimeInterval) {
                clearInterval(waitTimeInterval);
            }

            waitTimeInterval = setInterval(() => {
                if (!estimatedCompletionTime) return;

                const now = new Date();
                const timeLeft = estimatedCompletionTime - now;

                if (timeLeft <= 0) {
                    document.getElementById('orderWaitTime').textContent = 'Any moment now...';
                    clearInterval(waitTimeInterval);
                    waitTimeInterval = null;
                } else {
                    const minutes = Math.floor(timeLeft / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    document.getElementById('orderWaitTime').textContent = `${minutes}m ${seconds}s`;
                }
            }, 1000);
        }

        // NEW: Periodic order status polling
        function startOrderStatusPolling() {
            if (orderStatusInterval) {
                clearInterval(orderStatusInterval);
            }

            orderStatusInterval = setInterval(async () => {
                if (!currentOrder || !developerKey) return;

                try {
                    console.log('Polling order status...');
                    const response = await fetch(`${API_BASE}/api/v1/queue/list?admin=true`, {
                        headers: { 'X-API-Key': developerKey }
                    });

                    const data = await response.json();

                    if (response.ok && data.queue) {
                        const myOrder = data.queue.find(order => order.id === currentOrder);
                        if (myOrder) {
                            console.log('Found my order in polling:', myOrder);
                            handleMyOrderUpdate(myOrder);
                        } else {
                            // Order not found in queue - completed!
                            console.log('Order not found in queue - order completed');

                            // Stop polling immediately
                            clearInterval(orderStatusInterval);
                            orderStatusInterval = null;

                            // Show completion and auto-return to order form
                            showOrderComplete();
                        }
                    }
                } catch (error) {
                    console.error('Failed to poll order status:', error);
                }
            }, 3000); // Poll every 3 seconds
        }

        function handleOrderUpdate(data) {
            if (!currentOrder || data.orderId !== currentOrder) return;

            console.log('Handling order update for my order:', data.action);

            switch (data.action) {
                case 'finalized':
                case 'pickup_ready':
                    // Refresh order status to get PiQUP code (only if not already showing)
                    if (document.getElementById('pickupSection').classList.contains('hidden')) {
                        checkForPickupCode();
                    }
                    break;

                case 'completed':
                    showOrderComplete();
                    break;

                case 'cancelled':
                    showAlert('Your order has been cancelled', 'error');
                    startNewOrder();
                    break;
            }
        }

        function handleMyOrderUpdate(orderData) {
            console.log('My order data updated:', orderData);

            if (orderData.finalized && orderData.pickup_code && orderData.pickup_code !== 'PENDING') {
                // Only show pickup code if not already showing it
                if (document.getElementById('pickupSection').classList.contains('hidden')) {
                    showPickupCode(orderData.pickup_code);
                }
            } else if (orderData.status === 'completed') {
                showOrderComplete();
            } else if (orderData.cancelled) {
                showAlert('Your order has been cancelled', 'error');
                startNewOrder();
            } else {
                // Update position and wait time if still waiting
                if (!orderData.finalized) {
                    updateOrderPosition(orderData);
                }
            }
        }

        function updateOrderPosition(orderData) {
            // Position removed - only update estimated completion time
            if (orderData.estimated_completion) {
                estimatedCompletionTime = new Date(orderData.estimated_completion);
                if (!waitTimeInterval) {
                    startWaitTimeCountdown();
                }
            }
        }

        async function checkForPickupCode() {
            try {
                console.log('Checking for pickup code...');

                const response = await fetch(`${API_BASE}/api/v1/queue/list?admin=true`, {
                    headers: { 'X-API-Key': developerKey }
                });

                const data = await response.json();

                if (response.ok && data.queue) {
                    const myOrder = data.queue.find(order => order.id === currentOrder);
                    if (myOrder) {
                        console.log('Found my order:', myOrder);
                        if (myOrder.finalized && myOrder.pickup_code && myOrder.pickup_code !== 'PENDING') {
                            showPickupCode(myOrder.pickup_code);
                        } else if (myOrder.finalized) {
                            // Order is finalized but no pickup code yet, wait a bit and check again
                            setTimeout(checkForPickupCode, 1000);
                        }
                    }
                } else {
                    console.error('Failed to get order details:', data.error);
                }
            } catch (error) {
                console.error('Failed to check pickup code:', error);
                // Retry after a short delay
                setTimeout(checkForPickupCode, 2000);
            }
        }

        function showPickupCode(code) {
            document.getElementById('orderCurrentStatus').textContent = 'Ready for PiQUP';
            document.getElementById('pickupCode').textContent = code;

            hideElement('orderStatus');
            showElement('pickupSection');

            // Start logo rain when PiQUP code is shown
            startLogoRain();

            // Stop timers but KEEP polling to detect completion
            if (waitTimeInterval) {
                clearInterval(waitTimeInterval);
                waitTimeInterval = null;
            }

            // Make sure we're still polling for completion
            if (!orderStatusInterval && currentOrder) {
                startOrderStatusPolling();
            }

            console.log('PiQUP code received:', code);
        }

        function showOrderComplete() {
            hideElement('orderStatus');
            hideElement('pickupSection');

            // Stop logo rain
            stopLogoRain();

            // Stop all intervals
            if (waitTimeInterval) {
                clearInterval(waitTimeInterval);
                waitTimeInterval = null;
            }
            if (orderStatusInterval) {
                clearInterval(orderStatusInterval);
                orderStatusInterval = null;
            }

            console.log('Order completed');
            showAlert('Order completed! Thank you for using QUP.', 'success');

            // Go directly back to order form after 1 second
            setTimeout(() => {
                startNewOrder();
            }, 1000);
        }

        function startNewOrder() {
            // Reset state
            currentOrder = null;
            estimatedCompletionTime = null;

            // Stop logo rain
            stopLogoRain();

            // Stop all intervals
            if (waitTimeInterval) {
                clearInterval(waitTimeInterval);
                waitTimeInterval = null;
            }
            if (orderStatusInterval) {
                clearInterval(orderStatusInterval);
                orderStatusInterval = null;
            }

            // Reset UI
            document.getElementById('orderDescription').value = '';
            // Keep customer name for convenience
            hideElement('orderStatus');
            hideElement('pickupSection');
            hideElement('completeSection');
            showElement('orderForm');

            console.log('Ready for new order');
        }

        // Utility functions
        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function setLoading(type, loading) {
            if (type === 'login') {
                const text = document.getElementById('loginText');
                const spinner = document.getElementById('loginLoading');

                if (loading) {
                    text.style.display = 'none';
                    spinner.classList.remove('hidden');
                } else {
                    text.style.display = 'inline';
                    spinner.classList.add('hidden');
                }
            } else if (type === 'order') {
                const text = document.getElementById('orderButtonText');
                const spinner = document.getElementById('orderLoading');
                const button = text.parentElement;

                if (loading) {
                    text.style.display = 'none';
                    spinner.classList.remove('hidden');
                    button.disabled = true;
                } else {
                    text.style.display = 'inline';
                    spinner.classList.add('hidden');
                    button.disabled = false;
                }
            }
        }

        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alerts');

            // Clear existing alerts of the same message to prevent duplicates
            const existingAlerts = alertsContainer.querySelectorAll('.alert');
            existingAlerts.forEach(alert => {
                if (alert.textContent === message) {
                    alert.remove();
                }
            });

            const alert = document.createElement('div');
            alert.className = `alert alert-${type} fade-in`;
            alert.textContent = message;

            alertsContainer.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Handle Enter key in form fields
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('password').focus();
                }
            });

            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            document.getElementById('customerName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('orderDescription').focus();
                }
            });

            document.getElementById('orderDescription').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    placeOrder();
                }
            });
        });

        // Flash screen effect when clicking PiQUP code
        function flashScreen() {
            // Create flash overlay
            const flashDiv = document.createElement('div');
            flashDiv.className = 'screen-flash';
            document.body.appendChild(flashDiv);

            // Remove after animation completes
            setTimeout(() => {
                if (document.body.contains(flashDiv)) {
                    document.body.removeChild(flashDiv);
                }
            }, 800);

            console.log('PiQUP code flashed!');
        }

        // Test mode function (bypasses Supabase)
        function skipAuth() {
            console.log('Entering test mode (bypassing Supabase auth)');
            const testUser = {
                email: 'test@example.com',
                id: 'test-user-' + Date.now()
            };
            showApp(testUser);
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
(myenv) chris@Chris-qupcorp:~/repo/qupcorev2/supercode/qup-api/qup-frontend-testing$ cat admin.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUP Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #4c63d2;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a3e;
            --bg-card: #262654;
            --text-primary: #ffffff;
            --text-secondary: #a5a5c9;
            --border: #3a3a6b;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border);
        }

        .logo-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            border: 2px solid var(--border);
            object-fit: contain;
            background: var(--bg-secondary);
        }

        .logo {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .connection-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 24px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab:hover:not(.active) {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .card h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        /* Logo Management Styles */
        .logo-upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: var(--bg-card);
        }

        .upload-area.dragover {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .logo-preview {
            text-align: center;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 15px;
            border: 2px solid var(--border);
            margin-bottom: 15px;
            object-fit: contain;
            background: var(--bg-primary);
        }

        .logo-info {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .info-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .settings-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .settings-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-control[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            border: 1px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border-color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border-color: var(--danger);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.15);
            color: var(--info);
            border-color: var(--info);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        .hidden {
            display: none;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .login-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid var(--border);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .queue-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .queue-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .queue-position {
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-waiting {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning);
        }

        .status-processing {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
        }

        .status-ready {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-completed {
            background: rgba(107, 114, 128, 0.2);
            color: var(--text-secondary);
        }

        .config-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .two-column {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .config-actions {
                flex-direction: column;
            }

            .logo-upload-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="logo">QUP Admin</div>
            <div style="color: var(--text-secondary); margin-bottom: 30px;">
                Complete Queue Management System
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" class="form-control" placeholder="Enter your email" autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter your password" autocomplete="current-password">
                </div>

                <button type="button" class="btn btn-primary" id="loginBtn" style="width: 100%;">
                    <span id="loginText">Sign In</span>
                    <div id="loginLoading" class="loading hidden"></div>
                </button>
            </form>

            <div id="loginError" class="alert alert-error hidden">
                Login failed. Please check your credentials.
            </div>

            <div style="margin-top: 20px; font-size: 0.9rem; color: var(--text-secondary);">
                Use your Supabase account to access the admin dashboard.<br>
                <button type="button" style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; margin-top: 10px;" id="showSignUpBtn">
                    Need an account? Sign up here
                </button>
            </div>
        </div>
    </div>

    <!-- Sign Up Screen -->
    <div id="signUpScreen" class="login-screen hidden">
        <div class="login-card">
            <div class="logo">QUP Admin</div>
            <div style="color: var(--text-secondary); margin-bottom: 30px;">
                Create Admin Account
            </div>

            <form id="signUpForm">
                <div class="form-group">
                    <label for="signUpEmail">Email:</label>
                    <input type="email" id="signUpEmail" class="form-control" placeholder="Enter your email" autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="signUpPassword">Password:</label>
                    <input type="password" id="signUpPassword" class="form-control" placeholder="Choose a password (min 6 characters)" autocomplete="new-password">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password:</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm your password" autocomplete="new-password">
                </div>

                <button type="button" class="btn btn-primary" id="signUpBtn" style="width: 100%;">
                    <span id="signUpText">Create Account</span>
                    <div id="signUpLoading" class="loading hidden"></div>
                </button>
            </form>

            <div id="signUpError" class="alert alert-error hidden">
                Sign up failed. Please try again.
            </div>

            <div id="signUpSuccess" class="alert alert-success hidden">
                Account created! Please check your email to verify your account.
            </div>

            <div style="margin-top: 20px; font-size: 0.9rem; color: var(--text-secondary);">
                Already have an account?<br>
                <button type="button" style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; margin-top: 10px;" id="backToLoginBtn">
                    Back to Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="container hidden">
        <!-- Header -->
        <div class="header">
            <div class="logo-header">
                <img id="headerLogo" class="current-logo" src="" alt="Current Logo" style="display: none;">
                <div>
                    <div class="logo">QUP Admin Dashboard</div>
                    <div style="color: var(--text-secondary); margin-top: 5px;">Enterprise Queue Management</div>
                </div>
            </div>
            <div class="user-info">
                <div class="connection-status" id="connectionStatus">
                    <div class="connection-dot"></div>
                    <span>Connecting...</span>
                </div>

                <!-- Server Mode Toggle -->
                <div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Server:</span>
                    <select id="serverModeSelect" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                        <option value="remote">Remote (Production)</option>
                        <option value="local">Local (Development)</option>
                    </select>
                </div>

                <span id="adminUser" style="color: var(--text-secondary);"></span>
                <button class="btn btn-danger" id="logoutBtn">Logout</button>
            </div>
        </div>

        <!-- Metrics Overview -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="totalOrders">-</div>
                <div class="metric-label">Total Orders</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="activeOrders">-</div>
                <div class="metric-label">Active Orders</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="poolTime">-</div>
                <div class="metric-label">Pool Time (s)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="connectedClients">-</div>
                <div class="metric-label">Connected Clients</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="queue">Queue Management</div>
            <div class="tab" data-tab="settings">Settings & Branding</div>
            <div class="tab" data-tab="orders">Order Operations</div>
            <div class="tab" data-tab="system">System Status</div>
            <div class="tab" data-tab="monitor">Live Monitor</div>
            <div class="tab" data-tab="logs">Audit Logs</div>
        </div>

        <!-- Queue Management Tab -->
        <div id="queueTab" class="tab-content active">
            <div class="card">
                <h3>Live Queue</h3>
                <div class="btn-group">
                    <button class="btn btn-primary" id="refreshQueueBtn">Refresh</button>
                    <button class="btn btn-success" id="exportQueueBtn">Export</button>
                    <button class="btn btn-warning" id="clearCompletedBtn">Clear Completed</button>
                </div>
                <div id="queueContainer">
                    <div id="queueLoading" class="alert alert-info">Loading queue...</div>
                </div>
            </div>
        </div>

        <!-- Settings Tab with Logo Management -->
        <div id="settingsTab" class="tab-content">
            <!-- Logo Management Section -->
            <div class="card">
                <h3> Company Branding & Logo Management</h3>
                <div class="logo-upload-section">
                    <!-- Upload Area -->
                    <div>
                        <div class="upload-area" onclick="document.getElementById('logoFile').click()">
                            <div class="upload-icon"></div>
                            <div class="upload-text">
                                <strong>Click to upload logo</strong><br>
                            or drag and drop your logo here
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px;">
                                Supports: PNG, JPG, SVG (Max 2MB)
                            </div>
                        </div>
                        <input type="file" id="logoFile" class="file-input" accept="image/*" onchange="handleFileSelect(event)">

                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-success" id="uploadBtn" onclick="uploadLogo()" disabled>
                                <span id="uploadText">Upload Logo</span>
                                <div id="uploadLoading" class="loading hidden"></div>
                            </button>
                            <button class="btn btn-danger" onclick="deleteLogo()" style="margin-left: 10px;">
                                Delete Current Logo
                            </button>
                        </div>
                    </div>

                    <!-- Preview Area -->
                    <div class="logo-preview">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Preview</h4>
                        <img id="previewImage" class="preview-image" src="" alt="Logo Preview" style="display: none;">
                        <div id="noPreview" style="color: var(--text-secondary); font-style: italic;">
                            No logo selected
                        </div>

                        <div class="logo-info" id="logoInfo" style="display: none;">
                            <div class="info-row">
                                <span class="info-label">File Name:</span>
                                <span class="info-value" id="fileName">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">File Size:</span>
                                <span class="info-value" id="fileSize">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Dimensions:</span>
                                <span class="info-value" id="fileDimensions">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Type:</span>
                                <span class="info-value" id="fileType">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logo Display Settings -->
                <h4 style="color: var(--primary); margin-bottom: 15px;">Logo Display Settings</h4>
                <div class="settings-grid">
                    <div class="settings-section">
                        <h4>Barista Dashboard</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="showBarista" class="form-control" checked>
                            <label for="showBarista">Show logo in barista dashboard</label>
                        </div>
                        <div class="form-group">
                            <label for="baristaSize">Logo size (px):</label>
                            <input type="number" id="baristaSize" class="form-control" value="40" min="20" max="100">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Client App</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="showClient" class="form-control" checked>
                            <label for="showClient">Show logo in client app</label>
                        </div>
                        <div class="form-group">
                            <label for="clientSize">Logo size (px):</label>
                            <input type="number" id="clientSize" class="form-control" value="50" min="20" max="100">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>PiQUP Screen Protection</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableRain" class="form-control" checked>
                            <label for="enableRain">Enable logo rain on PiQUP screen</label>
                        </div>
                        <div class="form-group">
                            <label for="rainIntensity">Rain intensity (logos per second):</label>
                            <input type="number" id="rainIntensity" class="form-control" value="3" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label for="rainOpacity">Rain logo opacity (%):</label>
                            <input type="number" id="rainOpacity" class="form-control" value="30" min="10" max="80">
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <button class="btn btn-success" onclick="saveLogoSettings()">
                        Save Logo Settings
                    </button>
                    <button class="btn btn-primary" onclick="loadCurrentLogo()" style="margin-left: 10px;">
                        Refresh Logo
                    </button>
                </div>
            </div>

            <!-- System Configuration -->
            <div class="card">
                <h3>System Configuration</h3>
                <div class="settings-grid">
                    <!-- Queue Configuration -->
                    <div class="settings-section">
                        <h4>Queue Settings</h4>
                        <div class="form-group">
                            <label for="queueName">ueue Name:</label>
                            <input type="text" id="queueName" class="form-control" value="Production Queue">
                        </div>
                        <div class="form-group">
                            <label for="queueMode">Queue Mode:</label>
                            <select id="queueMode" class="form-control">
                                <option value="fifo">FIFO (First In, First Out)</option>
                                <option value="super_qup">Super QUP (Priority + Pool Time)</option>
                                <option value="negotiation">Negotiation (Payment System)</option>
                                <option value="chaos">Chaos (Random)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxQueueSize">Max Queue Size:</label>
                            <input type="number" id="maxQueueSize" class="form-control" value="1000">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableQueue" class="form-control" checked>
                            <label for="enableQueue">Enable Queue Processing</label>
                        </div>
                    </div>

                    <!-- Time Management -->
                    <div class="settings-section">
                        <h4>Time Management</h4>
                        <div class="form-group">
                            <label for="defaultTimeEstimate">Default Time Estimate (seconds):</label>
                            <input type="number" id="defaultTimeEstimate" class="form-control" value="120">
                        </div>
                        <div class="form-group">
                            <label for="poolTimeBuffer">Pool Time Buffer (seconds):</label>
                            <input type="number" id="poolTimeBuffer" class="form-control" value="30">
                        </div>
                        <div class="form-group">
                            <label for="timeDecayRate">Time Decay Rate:</label>
                            <input type="number" id="timeDecayRate" class="form-control" step="0.1" value="0.1">
                        </div>
                        <div class="form-group">
                            <label for="maxPoolTime">Max Pool Time (seconds):</label>
                            <input type="number" id="maxPoolTime" class="form-control" value="300">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableTimeManagement" class="form-control" checked>
                            <label for="enableTimeManagement">Enable Time Management</label>
                        </div>
                    </div>

                    <!-- Priority Settings -->
                    <div class="settings-section">
                        <h4>Priority Settings</h4>
                        <div class="form-group">
                            <label for="basePriority">Base Priority:</label>
                            <input type="number" id="basePriority" class="form-control" value="500">
                        </div>
                        <div class="form-group">
                            <label for="priorityIncrement">Priority Increment:</label>
                            <input type="number" id="priorityIncrement" class="form-control" value="50">
                        </div>
                        <div class="form-group">
                            <label for="maxPriority">Max Priority:</label>
                            <input type="number" id="maxPriority" class="form-control" value="1000">
                        </div>
                        <div class="form-group">
                            <label for="minPriority">Min Priority:</label>
                            <input type="number" id="minPriority" class="form-control" value="100">
                        </div>
                    </div>

                    <!-- Super QUP Settings -->
                    <div class="settings-section">
                        <h4>Super QUP Settings</h4>
                        <div class="form-group">
                            <label for="superQupCost">Super QUP Cost:</label>
                            <input type="number" id="superQupCost" class="form-control" step="0.01" value="1.50">
                        </div>
                        <div class="form-group">
                            <label for="superQupTimeBonus">Time Bonus (seconds):</label>
                            <input type="number" id="superQupTimeBonus" class="form-control" value="60">
                        </div>
                        <div class="form-group">
                            <label for="superQupPriorityBonus">Priority Bonus:</label>
                            <input type="number" id="superQupPriorityBonus" class="form-control" value="200">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableSuperQup" class="form-control" checked>
                            <label for="enableSuperQup">Enable Super QUP</label>
                        </div>
                    </div>

                    <!-- System Notification Settings -->
                    <div class="settings-section">
                        <h4>Notification Settings</h4>
                        <div class="form-group">
                            <label for="notificationDelay">Notification Delay (ms):</label>
                            <input type="number" id="notificationDelay" class="form-control" value="1000">
                        </div>
                        <div class="form-group">
                            <label for="emailNotificationThreshold">Email Threshold (queue size):</label>
                            <input type="number" id="emailNotificationThreshold" class="form-control" value="50">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableNotifications" class="form-control" checked>
                            <label for="enableNotifications">Enable Notifications</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableEmailNotifications" class="form-control">
                            <label for="enableEmailNotifications">Enable Email Notifications</label>
                        </div>
                    </div>

                    <!-- Debug Settings -->
                    <div class="settings-section">
                        <h4>Debug Settings</h4>
                        <div class="form-group">
                            <label for="logLevel">Log Level:</label>
                            <select id="logLevel" class="form-control">
                                <option value="error">Error</option>
                                <option value="warn">Warning</option>
                                <option value="info" selected>Info</option>
                                <option value="debug">Debug</option>
                                <option value="trace">Trace</option>
                            </select>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableDebugMode" class="form-control">
                            <label for="enableDebugMode">Enable Debug Mode</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableVerboseLogging" class="form-control">
                            <label for="enableVerboseLogging">Enable Verbose Logging</label>
                        </div>
                    </div>
                </div>

                <div class="config-actions">
                    <button class="btn btn-primary" id="saveAllSettingsBtn">Save All Settings</button>
                    <button class="btn btn-warning" id="loadSettingsBtn">Reload from Server</button>
                    <button class="btn btn-info" id="exportSettingsBtn">Export Settings</button>
                    <button class="btn btn-danger" id="resetAllSettingsBtn">Reset to Defaults</button>
                </div>
            </div>
        </div>

        <!-- Order Operations Tab -->
        <div id="ordersTab" class="tab-content">
            <div class="two-column">
                <div class="card">
                    <h3>Add Order</h3>
                    <form id="addOrderForm">
                        <div class="form-group">
                            <label for="orderId">Order ID:</label>
                            <input type="text" id="orderId" class="form-control" placeholder="auto-generated">
                        </div>
                        <div class="form-group">
                            <label for="orderDescription">Order Description:</label>
                            <textarea id="orderDescription" class="form-control" rows="3" placeholder="Large coffee with milk, no sugar"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Customer Email:</label>
                            <input type="email" id="customerEmail" class="form-control" placeholder="customer@example.com">
                        </div>
                        <button type="button" class="btn btn-primary" id="addOrderBtn">Add Order</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Order Actions</h3>
                    <div class="form-group">
                        <label for="actionOrderId">Order ID:</label>
                        <input type="text" id="actionOrderId" class="form-control" placeholder="Enter order ID">
                    </div>
                    <div class="btn-group" style="flex-direction: column;">
                        <button class="btn btn-success" id="finalizeOrderBtn">Finalize Order</button>
                        <button class="btn btn-primary" id="completeOrderBtn">Complete Order</button>
                        <button class="btn btn-danger" id="cancelOrderBtn">Cancel Order</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status Tab -->
        <div id="systemTab" class="tab-content">
            <div class="card">
                <h3>System Health</h3>
                <div id="systemHealth">Loading system status...</div>
            </div>
        </div>

        <!-- Live Monitor Tab -->
        <div id="monitorTab" class="tab-content">
            <div class="card">
                <h3>Live System Variables</h3>
                <div class="btn-group">
                    <button class="btn btn-primary" id="refreshMonitorBtn">Refresh All Data</button>
                    <button class="btn btn-success" id="exportMonitorBtn">Export Variables</button>
                    <button class="btn btn-info" id="toggleAutoRefreshBtn">
                        <span id="autoRefreshText">Stop Auto-Refresh</span>
                    </button>
                </div>
                <div id="monitorContent">Loading all system variables...</div>
            </div>
        </div>

        <!-- Audit Logs Tab -->
        <div id="logsTab" class="tab-content">
            <div class="card">
                <h3>Audit Logs</h3>
                <div id="logsContainer">
                    <div class="alert alert-info">Click refresh to load audit trail</div>
                </div>
            </div>
        </div>

        <!-- Alerts Container -->
        <div id="alertsContainer"></div>
    </div>

    <script>
        // Global state variables
        let adminKey = null;
        let socket = null;
        let currentConfig = {};
        let refreshInterval = null;
        let monitorInterval = null;
        let autoRefreshEnabled = true;
        let supabase = null;
        let currentUser = null;
        let systemData = {};

        // Logo management variables
        let selectedFile = null;
        let currentLogo = null;

        // Configuration constants
        const SUPABASE_URL = 'https://eorhgophbjjbiguvkygo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvcmhnb3BoYmpqYmlndXZreWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MjMyMjUsImV4cCI6MjA2NDM5OTIyNX0.fV_6TFXfjDVusTeknF_LAGjxw7BfTZtoQ0helbm5mwo';

        //  DEVELOPMENT CONFIGURATION
        const API_ENDPOINTS = {
            local: 'http://localhost:8080',   // Your local QUP server
            remote: 'https://qupcore-supercode-692478335867.us-central1.run.app'  // Production QUP server
        };

        // Initialize from localStorage or default to remote
        let USE_LOCAL_DEV = localStorage.getItem('qup_use_local_dev') === 'true';
        let API_BASE = USE_LOCAL_DEV ? API_ENDPOINTS.local : API_ENDPOINTS.remote
        // Dynamic feature flags based on current server mode
        function getServerFeatures() {
            return {
                hasNewConfigEndpoints: USE_LOCAL_DEV,  // New /api/v1/config/* endpoints
                hasEnhancedSettings: USE_LOCAL_DEV,    // Enhanced settings management
                supportsCORS: USE_LOCAL_DEV             // Proper CORS headers
            };
        }

        let SERVER_FEATURES = getServerFeatures();

        // Default configuration values
        const DEFAULT_CONFIG = {
            queueName: 'Production Queue',
            queueMode: 'super_qup',
            maxQueueSize: 1000,
            enableQueue: true,
            defaultTimeEstimate: 120,
            poolTimeBuffer: 30,
            timeDecayRate: 0.1,
            maxPoolTime: 300,
            enableTimeManagement: true,
            basePriority: 500,
            priorityIncrement: 50,
            maxPriority: 1000,
            minPriority: 100,
            superQupCost: 1.50,
            superQupTimeBonus: 60,
            superQupPriorityBonus: 200,
            enableSuperQup: true,
            notificationDelay: 1000,
            emailNotificationThreshold: 50,
            enableNotifications: true,
            enableEmailNotifications: false,
            logLevel: 'info',
            enableDebugMode: false,
            enableVerboseLogging: false
        };

        // Initialize application
        function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized');
            } catch (error) {
                console.error('Supabase initialization failed:', error);
                showAlert('Failed to initialize authentication system', 'error');
                return;
            }

            setupEventListeners();
            loadDefaultSettings();
            setupDragAndDrop();
            checkExistingSession();
            console.log('QUP Admin Dashboard initialized');
        }

        function loadDefaultSettings() {
            Object.keys(DEFAULT_CONFIG).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = DEFAULT_CONFIG[key];
                    } else {
                        element.value = DEFAULT_CONFIG[key];
                    }
                }
            });
        }

        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('showSignUpBtn').addEventListener('click', showSignUp);
            document.getElementById('signUpBtn').addEventListener('click', signUp);
            document.getElementById('backToLoginBtn').addEventListener('click', showLogin);
            document.getElementById('logoutBtn').addEventListener('click', logout);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.target.getAttribute('data-tab');
                    showTab(tabName);
                });
            });

            document.getElementById('refreshQueueBtn').addEventListener('click', refreshQueue);
            document.getElementById('exportQueueBtn').addEventListener('click', exportQueue);
            document.getElementById('clearCompletedBtn').addEventListener('click', clearCompleted);

            document.getElementById('saveAllSettingsBtn').addEventListener('click', saveAllSettings);
            document.getElementById('loadSettingsBtn').addEventListener('click', loadSettings);
            document.getElementById('exportSettingsBtn').addEventListener('click', exportSettings);
            document.getElementById('resetAllSettingsBtn').addEventListener('click', resetAllSettings);

            document.getElementById('addOrderBtn').addEventListener('click', addOrder);
            document.getElementById('finalizeOrderBtn').addEventListener('click', finalizeOrder);
            document.getElementById('completeOrderBtn').addEventListener('click', completeOrder);
            document.getElementById('cancelOrderBtn').addEventListener('click', cancelOrder);

            document.getElementById('refreshMonitorBtn').addEventListener('click', loadMonitor);
            document.getElementById('exportMonitorBtn').addEventListener('click', exportMonitorData);
            document.getElementById('toggleAutoRefreshBtn').addEventListener('click', toggleAutoRefresh);

            document.getElementById('email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('password').focus();
            });
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });

            // Server mode toggle
            document.getElementById('serverModeSelect').addEventListener('change', switchServerMode);
        }

        // Server Mode Management
        function switchServerMode(event) {
            const newMode = event.target.value;
            const isLocal = newMode === 'local';

            if (isLocal === USE_LOCAL_DEV) {
                return; // No change needed
            }

            // Update configuration
            USE_LOCAL_DEV = isLocal;
            API_BASE = USE_LOCAL_DEV ? API_ENDPOINTS.local : API_ENDPOINTS.remote;
            SERVER_FEATURES = getServerFeatures();

            // Save preference
            localStorage.setItem('qup_use_local_dev', USE_LOCAL_DEV.toString());

            // Disconnect current connections
            if (socket) {
                socket.disconnect();
                socket = null;
            }

            // Show user feedback
            const modeText = USE_LOCAL_DEV ? 'Local Development' : 'Remote Production';
            const apiText = USE_LOCAL_DEV ? API_ENDPOINTS.local : API_ENDPOINTS.remote;

            showAlert(` Switched to ${modeText} server (${apiText})`, 'info');

            // If we're logged in, rennect with new server
            if (currentUser && adminKey) {
                // Re-establish connections with new server
                connectWebSocket();
                updateMetrics();

                // Reload current tab data
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('data-tab');
                    showTab(tabName);
                }

                showAlert(` Reconnected to ${modeText} server`, 'success');
            }
        }

        function initializeServerMode() {
            // Set the dropdown to match current mode
            const dropdown = document.getElementById('serverModeSelect');
            dropdown.value = USE_LOCAL_DEV ? 'local' : 'remote';

            // Show current mode in console
            const modeText = USE_LOCAL_DEV ? 'Local Development' : 'Remote Production';
            conle.log(`ver Mode: ${modeText} (${API_BASE})`);
        }

        // Logo Management Functions
        function setupDragAndDrop() {
            const uploadArea = document.querySelector('.upload-area');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.reove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showAlert('Please select an image file (PNG, JPG, SVG)', 'error');
                return;
            }

            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                showAlert('File size must be less than 2MB', 'error');
                return;
            }

            selectedFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewImage = document.getElementById('previewImage');
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
                document.getElementById('noPreview').style.display = 'none';

                // Show file info
                showFileInfo(file, e.target.result);
            };
            reader.readAsDataURL(file);

            // Enable upload button
            document.getElementById('uploadBtn').disabled = false;
        }

        function showFileInfo(file, dataUrl) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type;

            // Get image dimensions
            const img = new Image();
            img.onload = () => {
                document.getElementById('fileDimensions').textContent = `${img.width}  ${img.height}`;
            };
            img.src = dataUrl;

            document.getElementById('logoInfo').style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixd(2)) + ' ' + sizes[i];
        }

        async function uploadLogo() {
            if (!selectedFile) {
                showAlert('Please select a file first', 'error');
                return;
            }

            setLoading('upload', true);

            try {
                // Create unique filename
                const fileExt = selectedFile.name.split('.').pop();
                const fileName = `logo-${Date.now()}.${fileExt}`;

                // Upload to Supabase Storage
                const { data, error } = await supabase.storage
                    .from('company-assets')
                    .upload(`logos/${fileName}`, selectedFile, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) throw error;

                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('company-assets')
                    .getPublicUrl(`logos/${fileName}`);

                const logoUrl = urlData.publicUrl;

                // Save logo info to database
                const logoData = {
                    logo_url: logoUrl,
                    file_name: selectedFile.name,
                    file_size: selectedFile.size,
                    file_type: selectedFile.type,
                    uploaded_at: new Date().toISOString(),
                    is_active: true
                };

                const { error: dbError } = await supabase
                    .from('company_logos')
                    .upsert(logoData, {
                        onConflict: 'is_active',
                        ignoreDuplicates: false
                    });

                if (dbError) throw dbError;

                currentLogo = logoData;
                updateHeaderLogo(logoUrl);

                showAlert('Logo uploaded successfully!', 'success');

                // Reset form
                selectedFile = null;
                document.getElementById('logoFile').value = '';
                document.getElementById('uploadBtn').disabled = true;

            } catch (error) {
                console.error('Upload failed:', error);
                showAlert('Upload failed: ' + error.message, 'error');
            } finally {
                setLoading('upload', false);
            }
        }

        async function loadCurrentLogo() {
            try {
                const { data, error } = await supabase
                    .from('company_logos')
                    .select('*')
                    .eq('is_active', true)
                    .order('uploaded_at', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    currentLogo = data[0];
                    updateHeaderLogo(currentLogo.logo_url);
                    showAlert('Current logo loaded', 'info');
                } else {
                    document.getElementById('headerLogo').style.display = 'none';
                    showAlert('No logo found. Please upload one.', 'info');
                }

                // Also load logo settings
                await loadLogoSettings();

            } catch (error) {
                console.error('Failed to load logo:', error);
                showAlert('Failed to load current logo', 'error');
            }
        }

        function updateHeaderLogo(logoUrl) {
            const headerLogo = document.getElementById('headerLogo');
            headerLogo.src = logoUrl;
            headerLogo.style.display = 'block';
        }

        async function deleteLogo() {
            if (!currentLogo) {
                showAlert('No logo to delete', 'error');
                return;
            }

            if (!confirm('Are you sure you want to delete the current logo?')) {
                return;
            }

            try {
                // Mark as inactive in database
                const { error: dbError } = await supabase
                    .from('company_logos')
                    .update({ is_active: false })
                    .eq('id', currentLogo.id);

                if (dbError) throw dbError;

                // Hide header logo
                document.getElementById('headerLogo').style.display = 'none';
                currentLogo = null;

                showAlert('Logo deleted successfully', 'success');

            } catch (error) {
                console.error('Delete failed:', error);
                showAlert('Failed to delete logo: ' + error.message, 'error');
            }
        }

        async function saveLogoSettings() {
            const settings = {
                show_barista: document.getElementById('showBarista').checked,
                barista_size: parseInt(document.getElementById('baristaSize').value),
                show_client: document.getElementById('showClient').checked,
                client_size: parseInt(document.getElementById('clientSize').value),
                enable_rain: document.getElementById('enableRain').checked,
                rain_intensity: parseInt(document.getElementById('rainIntensity').value),
                rain_opacity: parseInt(document.getElementById('rainOpacity').value),
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase
                    .from('logo_settings')
                    .upsert(settings, {
                        onConflict: 'id',
                        ignoreDuplicates: false
                    });

                if (error) throw error;

                showAlert('Logo settings saved successfully!', 'success');

            } catch (error) {
                console.error('Failed to save settings:', error);
                showAlert('Failed to save settings: ' + error.message, 'error');
            }
        }

        async function loadLogoSettings() {
            try {
                const { data, error } = await supabase
                    .from('logo_settings')
                    .select('*')
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    const settings = data[0];
                    document.getElementById('showBarista').checked = settings.show_barista ?? true;
                    document.getElementById('baristaSize').value = settings.barista_size ?? 40;
                    document.getElementById('showClient').checked = settings.show_client ?? true;
                    document.getElementById('clientSize').value = settings.client_size ?? 50;
                    document.getElementById('enableRain').checked = settings.enable_rain ?? true;
                    document.getElementById('rainIntensity').value = settings.rain_intensity ?? 3;
                    document.getElementById('rainOpacity').value = settings.rain_opacity ?? 30;
                }

            } catch (error) {
                console.error('Failed to load settings:', error);
                // Use defaults if loading fails
            }
        }

        async function checkExistingSession() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    console.log('Found existing session:', user.email);
                    currentUser = user;
                    document.getElementById('adminUser').textContent = `Admin: ${user.email}`;
                    await getAdminKeyAndShowDashboard();
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Failed to check existing session:', error);
                showLogin();
            }
        }

        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!email || !password) {
                showAlert('Please enter both email and password', 'error');
                return;
            }

            setLoading('login', true);
            document.getElementById('loginError').classList.add('hidden');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                console.log('Login successful for:', email);
                currentUser = data.user;
                document.getElementById('adminUser').textContent = `Admin: ${email}`;

                await getAdminKeyAndShowDashboard();
                showAlert('Login successful!', 'success');

            } catch (error) {
                console.error('Login failed:', error);
                document.getElementById('loginError').classList.remove('hidden');
                showAlert('Login failed: ' + error.message, 'error');
            } finally {
                setLoading('login', false);
            }
        }

        async function signUp() {
            const email = document.getElementById('signUpEmail').value.trim();
            const password = document.getElementById('signUpPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            if (!email || !password || !confirmPassword) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('Password must be at least 6 characters', 'error');
                return;
            }

            setLoading('signUp', true);

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) throw error;

                console.log('Sign up successful for:', email);
                document.getElementById('signUpSuccess').classList.remove('hidden');
                showAlert('Account created! Please check your email to verify.', 'success');

                document.getElementById('signUpEmail').value = '';
                document.getElementById('signUpPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                setTimeout(() => showLogin(), 3000);

            } catch (error) {
                console.error('Sign up failed:', error);
                document.getElementById('signUpError').classList.remove('hidden');
                showAlert('Sign up failed: ' + error.message, 'error');
            } finally {
                setLoading('signUp', false);
            }
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
                console.log('Logout successful');
            } catch (error) {
                console.error('Logout error:', error);
            }

            adminKey = null;
            currentUser = null;
            currentLogo = null;
            selectedFile = null;

            if (socket) {
                socket.disconnect();
                socket = null;
            }
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }

            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            showAlert('Logged out successfully', 'info');
        }

        async function getAdminKeyAndShowDashboard() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                const data = await response.json();

                if (response.ok && data.admin_key) {
                    adminKey = data.admin_key;
                    console.log('Admin key obtained');
                    showDashboard();
                } else {
                    throw new Error(data.error || 'Failed to get admin key');
                }
            } catch (error) {
                console.error('Failed to get admin key:', error);
                showAlert('Failed to get API access', 'warning');
                showDashboard();
            }
        }

        function showLogin() {
            document.getElementById('signUpScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showSignUp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('signUpScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('signUpScreen').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');

            // Initialize server mode dropdown
            initializeServerMode();

            // Load logo immediately when dashboard shows
            loadCurrentLogo();

            connectWebSocket();
            loadInitialData();
            startPeriodicRefresh();

            // Show development mode indicator if using local server
            if (USE_LOCAL_DEV) {
                showAlert(' Development Mode: Using local server with enhanced features', 'info');
            }
        }

        function showTab(tabName) {
          document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            switch (tabName) {
                case 'queue':
                    refreshQueue();
                    break;
                case 'settings':
                    loadSettings();
                    loadCurrentLogo(); // Load logo when settings tab is opened
                    break;
                case 'system':
                    loadSystemStatus();
                    break;
                case 'monitor':
                    loadMonitor();
                    break;
            }
        }

        function getCurrentSettings() {
            const settings = {};
            Object.keys(DEFAULT_CONFIG).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        settings[key] = element.checked;
                    } else if (element.type === 'number') {
                        settings[key] = parseFloat(element.value) || 0;
                    } else {
                        settings[key] = element.value;
                    }
                }
            });
            return settings;
        }

        function applySettingsToForm(settings) {
            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = settings[key];
                    } else {
                        element.value = settings[key];
                    }
                }
            });
        }

        async function saveAllSettings() {
            console.log('Saving all system settings...');
            const settings = getCurrentSettings();

            // Check if server supports new config endpoints
            if (SERVER_FEATURES.hasNewConfigEndpoints) {
                try {
                    // Map form settings to API config format
                    const apiConfig = {
                        queue_name: settings.queueName,
                        mode: settings.queueMode,
                        max_queue_size: settings.maxQueueSize,
                        default_time_estimate: settings.defaultTimeEstimate,
                        default_priority: settings.basePriority,
                        super_qup_enabled: settings.enableSuperQup,
                        qup_overhead_percent: 10.0,
                        drift_clear_percent: 5.0,
                        max_qup_time: settings.maxPoolTime,
                        ml_enabled: true,
                        negotiation_enabled: false,
                        chaos_enabled: false,
                        audit_enabled: true
                    };

                    // Use the NEW /api/v1/config/update endpoint
                    const response = await apiCall('/api/v1/config/update', {
                        method: 'POST',
                        body: JSON.stringify(apiConfig)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log(' Settings saved to server:', data);

                    // Also save logo settings to Supabase
                        await saveLogoSettings();

                        showAlert(' All settings saved to server database!', 'success');
                        return;

                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Server rejected configuration');
                    }

                } catch (error) {
                    console.error('led to  to server:', error);
                    showAlert(' Server save failed: ' + error.message, 'error');
                }
            } else {
                console.log(' Using legacy save method (server lacks new endpoints)');
            }

            // Fallback to local storage (works with both old and new servers)
            try {
                currentConfig = settings;
                localStorage.setItem('qup_admin_settings', JSON.stringify(settings));

                // Sti to save lotings
                await saveLogoSettings();

                const saveType = SERVER_FEATURES.hasNewConfigEndpoints ?
                    'locally only (server error)' :
                    'locally (server lacks new endpoints)';

                showAlert(` System settings saved ${saveType}. Logo settings saved to database.`, 'warning');

            } catch (logoError) {
                showAlert(' Failed to save settings. console for details.', 'error');
            }
        }

        asyntion loadSettings() {
            // Check if server supports new config endpoints
            if (SERVER_FEATURES.hasNewConfigEndpoints) {
                try {
                    // Try to load from NEW /api/v1/config/get endpoint first
                    const response = await apiCall('/api/v1/config/get');

                    if (response.ok) {
                        const data = await response.json();
                        console.log(' Loaded config from server:', data.config);

                      // Map server config back to form fields
                        const serverConfig = data.config;
                        const mappedSettings = {
                            queueName: serverConfig.queue_name || 'Production Queue',
                            queueMode: serverConfig.mode || 'super_qup',
                            maxQueueSize: serverConfig.max_queue_size || 1000,
                            enableQueue: true,
                            defaultTimeEstimate: serverConfig.default_time_estimate || 120,
                            poolTimeBuffer: 30,
                            timeDecayRate: 0.1,
                            maxPoolTime: serverConfig.max_qup_time || 300,
                            enableTimeManagement: true,
                            basePriority: serverConfig.default_priority || 500,
                            priorityIncrement: 50,
                            maxPriority: 1000,
                            minPriority: 100,
                            superQupCost: 1.50,
                            superQupTimeBonus: 60,
                            superQupPriorityBonus: 200,
                            enableSuperQup: serverConfig.super_qup_enabled !== false,
                            notificationDelay: 1000,
                            emailNotificationThreshold: 50,
                            enableNotifications: true,
                            enableEmailNotifications: false,
                            logLevel: 'info',
                            enableDebugMode: false,
                            enableVerboseLogging: false
                        };

                        currentConfig = mappedSettings;
                        applySettingsToForm(mappedSettings);
                        showAlert(' Settings loaded from server', 'success');

                        // Also load logo settings
                        await loadLogoSettings();
                        return;

                  } else {
                        throw new Error('Server cong not available');
                    }

                } catch (error) {
                    console.error(' Failed to load from server:', error);
                    showAlert(' Server load failed, using fallback', 'warning');
                }
            } else {
                console.log(' Using legacy load method (server lacks new endpoints)');
            }

            // Fallback to existing behaviorage + defaults)
            try {
                const localSettings = localSem('qup_admin_settings');
                if (localSettings) {
                    const parsedSettings = JSON.parse(localSettings);
                    currentConfig = { ...DEFAULT_CONFIG, ...parsedSettings };
                    applySettingsToForm(currentConfig);

                    const loadType = SERVER_FEATURES.hasNewConfigEndpoints ?
                        'from local storage (server error)' :
                        'from local storage (server lacks new endpoints)';

                    showAlert(` Settings loaded ${loadType}`, 'info');
                } else {
                    throw new Error('No local settings found');
                }
            } catch (localError) {
                console.error('Using defaults:', localError);
                applySettingsToForm(DEFAULT_CONFIG);
                showAlert(' Using default settings', 'info');
    }

            // Always try to load logo settings (independent)
            try {
                await loadLogoSettings();
          h (logoError) {
                console.error('Logo settings load failed:', logoError);
            }
        }

        function exportSettings() {
            const settings = getCurrentSettings();
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qup-settings-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showAlert('Settings exported successfully', 'success');
        }

        function resetAllSettings() {
            if (!confirm('Reset all settings to defaults? This will reset both server and local settings.')) {
                return;
            }

            // Check if server supports new reset endpoint
            if (SERVER_FEATURES.hasNewConfigEndpoints) {
                // Try server reset first
                apiCall('/api/v1/config/reset', {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Server reset failed');
                    }
                })
                .then(data => {
                    console.log(' Settings reset on server:', data);

                    // Apply defaults to form
                    plySettingsToForm(DEFAULT_CONFIG);

                    // Clear local storage
                    localStorage.removeItem('qup_admin_settings');
                    showAlert(' All settings reset to defaults (server + local)', 'success');

                    // Reload to show server defaults
                    setTimeout(() => loadSettings(), 1000);
            })
                .catch(error => {
                    console.error(' Server reset failed:', error);

                    // Fallbackcal reset only
                    applySettingsToForm(DEFAULT_CONFIG);
                    localStorage.removeItem('qup_admin_settings');
                    showAlert(' Settings reset locally only (server reset failed)', 'warning');
                });
            } else {
                // Server doesn't support new endpoints, only reset locally
        console.log(' Using legacy reset method (server lacks new endpoints)');
                applySettingsToForm(DEFAULT_CONFIG);
               orage.removeItem('qup_admin_settings');
                showAlert(' Settings reset locally (server lacks reset endpoint)', 'info');
            }
        }

        function connectWebSocket() {
            if (socket) return;

            socket = io(API_BASE, {
                transports: ['websocket', 'polling'],
                timeout: 20        });

            socket.on('connect', () => {
                updateConnectionStatus(true);
                console.log('WebSocket connected');
         );

            socket.on('disconnect', () => {
                updateConnectionStatus(false);
            });

            socket.on('queue_update', () => {
                refreshQueue();
            });
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status connected';
                status.innerHTML = '<div class="connection-dot"></div><span>Connected</span>';
            } else {
                status.className = 'connection-status disconnected';
                status.innerHTML = '<div class="connection-dot"></div><span>Disconnected</span>';
            }
        }

        async function loadInitialData() {
            await Promise.all([
                refreshQueue(),
                loadSettings(),
                updateMetrics()
            ]);
        }

        function startPeriodicRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                updateMetrics();
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id === 'queueTab') {
                    refreshQueue();
                }
                if (activeTab && activeTab.id === 'monitorTab' && autoRefreshEnabled) {
                    loadMonitor();
                }
            }, 5000);
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const text = document.getElementById('autoRefreshText');

            if (autoRefreshEnabled) {
                text.textContent = 'Stop Auto-Refresh';
                showAlert('Auto-refresh enabled', 'success');
            } else {
                text.textContent = 'Start Auto-Refresh';
                showAlert('Auto-refresh disabled', 'info');
            }
        }

        async function updateMetrics() {
            try {
                const response = await apiCall('/api/v1/queue/list?admin=true');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalOrders').textContent = data.total_elements || 0;
                    document.getElementById('activeOrders').textContent = data.active_elements || 0;

                    if (data.time_management) {
                        document.getElementById('poolTime').textContent =
                            Math.round(data.time_management.available_pool_time || 0);
                    }
                }

                const wsResponse = await apiCall('/api/websocket/status');
                if (wsResponse.ok) {
                    const wsData = await wsResponse.json();
                    document.getElementById('connectedClients').textContent = wsData.connected_clients || 0;
                }
            } catch (error) {
                console.error('Failed to update metrics:', error);
            }
        }

        async function refreshQueue() {
            try {
                console.log('Refreshing queue...');
                const response = await apiCall('/api/v1/queue/list?admin=true');
                const data = await response.json();

                if (response.ok) {
                    renderQueue(data.queue || []);
                } else {
                    throw new Error(data.error || 'Failed to load queue');
                }
            } catch (error) {
                console.error('Failed to refresh queue:', error);
                document.getElementById('queueContainer').innerHTML =
                    '<div class="alert alert-error">Failed to load queue: ' + error.message + '</div>';
            }
        }

        function renderQueue(queue) {
            try {
                const container = document.getElementById('queueContainer');

                if (queue.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">Queue is empty</div>';
                    return;
                }

                function escapeHtml(str) {
                    return String(str)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                }

                let html = '';
                for (let i = 0; i < queue.length; i++) {
                    const order = queue[i];

                    let statusClass = 'status-waiting';
                    if (order.status === 'waiting') statusClass = 'status-waiting';
                    else if (order.status === 'processing') statusClass = 'status-processing';
                    else if (order.status === 'pickup_ready') statusClass = 'status-ready';
                    else if (order.status === 'completed') statusClass = 'status-completed';

                    const safeId = escapeHtml(order.id || '');
                    const safeStatus = escapeHtml(order.status || '');
                    let safePayload = '';

                    try {
                        if (order.payload && order.payload.order) {
                            safePayload = escapeHtml(order.payload.order);
                        } else if (order.payload) {
                            safePayload = escapeHtml(JSON.stringify(order.payload));
                        } else {
                            safePayload = 'No order data';
                        }
                    } catch (e) {
                        safePayload = 'Error parsing order data';
                    }

                    const safePriority = escapeHtml(String(order.priority || 0));

                    html += `
                        <div class="queue-item">
                            <div class="queue-item-header">
                                <div class="queue-position">${i + 1}</div>
                                <div class="status-badge ${statusClass}">${safeStatus}</div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>ID:</strong> ${safeId}<br>
                                <strong>Order:</strong> ${safePayload}<br>
                                <strong>Priority:</strong> ${safePriority}
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="quickAction('finalize', '${safeId}')" style="padding: 6px 12px; font-size: 0.8rem;">
                                    Finalize
                                </button>
                                <button class="btn btn-primary" onclick="quickAction('complete', '${safeId}')" style="padding: 6px 12px; font-size: 0.8rem;">
                                    Complete
                                </button>
                                <button class="btn btn-danger" onclick="quickAction('cancel', '${safeId}')" style="padding: 6px 12px; font-size: 0.8rem;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;

            } catch (error) {
                console.error('Error rendering queue:', error);
                document.getElementById('queueContainer').innerHTML =
                    '<div class="alert alert-error">Failed to render queue: ' + error.message + '</div>';
            }
        }

        async function quickAction(action, orderId) {
            document.getElementById('actionOrderId').value = orderId;

            switch(action) {
                case 'finalize':
                    await finalizeOrder();
                    break;
                case 'complete':
                    await completeOrder();
                    break;
                case 'cancel':
                    await cancelOrder();
                    break;
            }
        }

        async function addOrder() {
            const orderId = document.getElementById('orderId').value ||
                          `admin-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
            const description = document.getElementById('orderDescription').value.trim();
            const email = document.getElementById('customerEmail').value.trim();

            if (!description) {
                showAlert('Order description is required', 'error');
                return;
            }

            try {
                const response = await apiCall('/api/v1/queue/add', {
                    method: 'POST',
                    body: JSON.stringify({
                        id: orderId,
                        payload: { order: description },
                        user_id: email || orderId,
                        priority: 500
                    })
                });

                if (response.ok) {
                    document.getElementById('orderId').value = '';
                    document.getElementById('orderDescription').value = '';
                    document.getElementById('customerEmail').value = '';

                    showAlert(`Order ${orderId} added successfully!`, 'success');
                    refreshQueue();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add order');
                }
            } catch (error) {
                console.error('Failed to add order:', error);
                showAlert('Failed to add order: ' + error.message, 'error');
            }
        }

        async function finalizeOrder() {
            const orderId = document.getElementById('actionOrderId').value.trim();
            if (!orderId) {
                showAlert('Please enter an Order ID', 'error');
                return;
            }

            try {
                const response = await apiCall('/api/v1/queue/finalize', {
                    method: 'POST',
                    body: JSON.stringify({ id: orderId })
                });

                if (response.ok) {
                    showAlert(`Order ${orderId} finalized!`, 'success');
                    refreshQueue();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to finalize order');
                }
            } catch (error) {
                showAlert('Failed to finalize order: ' + error.message, 'error');
            }
        }

        async function completeOrder() {
            const orderId = document.getElementById('actionOrderId').value.trim();
            if (!orderId) {
                showAlert('Please enter an Order ID', 'error');
                return;
            }

            try {
                const response = await apiCall('/api/v1/queue/complete', {
                    method: 'POST',
                    body: JSON.stringify({ id: orderId })
                });

                if (response.ok) {
                    showAlert(`Order ${orderId} completed!`, 'success');
                    refreshQueue();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to complete order');
                }
            } catch (error) {
                showAlert('Failed to complete order: ' + error.message, 'error');
            }
        }

        async function cancelOrder() {
            const orderId = document.getElementById('actionOrderId').value.trim();
            if (!orderId) {
                showAlert('Please enter an Order ID', 'error');
                return;
            }

            if (!confirm(`Cancel order ${orderId}?`)) return;

            try {
                const response = await apiCall('/api/v1/queue/cancel', {
                    method: 'POST',
                    body: JSON.stringify({ id: orderId })
                });

                if (response.ok) {
                    showAlert(`Order ${orderId} cancelled!`, 'success');
                    refreshQueue();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to cancel order');
                }
            } catch (error) {
                showAlert('Failed to cancel order: ' + error.message, 'error');
            }
        }

        async function loadSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('systemHealth').innerHTML = `
                        <div class="alert alert-${data.status === 'healthy' ? 'success' : 'error'}">
                            <strong>Status:</strong> ${data.status}<br>
                            <strong>Service:</strong> ${data.service}<br>
                            <strong>Version:</strong> ${data.version || 'Unknown'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load system status:', error);
                document.getElementById('systemHealth').innerHTML =
                    '<div class="alert alert-error">Failed to load system status</div>';
            }
        }

        async function loadMonitor() {
            document.getElementById('monitorContent').innerHTML = '<div class="alert alert-info">Loading all system variables...</div>';

            try {
                console.log('Starting monitor data load...');

                const promises = [
                    fetch(`${API_BASE}/health`).catch(e => ({ ok: false, error: e.message })),
                    apiCall('/api/v1/queue/list?admin=true').catch(e => ({ ok: false, error: e.message })),
                    apiCall('/api/websocket/status').catch(e => ({ ok: false, error: e.message })),
                    fetch(`${API_BASE}/api/client/config`).catch(e => ({ ok: false, error: e.message }))
                ];

                const [healthResponse, queueResponse, wsResponse, configResponse] = await Promise.all(promises);

                const healthData = healthResponse.ok ? await healthResponse.json() : { error: healthResponse.error };
                const queueData = queueResponse.ok ? await queueResponse.json() : { error: queueResponse.error };
                const wsData = wsResponse.ok ? await wsResponse.json() : { error: wsResponse.error };
                const configData = configResponse.ok ? await configResponse.json() : { error: configResponse.error };

                systemData = {
                    timestamp: new Date().toISOString(),
                    health: healthData,
                    queue: queueData,
                    websocket: wsData,
                    config: configData,
                    client_state: {
                        admin_key_available: !!adminKey,
                        supabase_user: currentUser && currentUser.email ? currentUser.email : null,
                        auto_refresh: autoRefreshEnabled,
                        socket_connected: socket && socket.connected ? socket.connected : false
                    },
                    current_settings: getCurrentSettings(),
                    logo_info: currentLogo
                };

                console.log('systemData loaded:', systemData);
                renderMonitorDisplay(systemData);

            } catch (error) {
                console.error('Failed to load monitor data:', error);
                document.getElementById('monitorContent').innerHTML =
                    '<div class="alert alert-error">Failed to load monitor data: ' + error.message + '</div>';
            }
        }

        function renderMonitorDisplay(data) {
            try {
                let html = '';
                html += '<div style="margin-bottom: 20px; text-align: center; color: var(--text-secondary);">';
                html += '<span style="color: var(--success);"></span> Live System Monitor - Last Updated: ';
                html += new Date().toLocaleTimeString();
                html += '</div>';

                html += '<div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; max-height: 500px; overflow-y: auto;">';
                ml += '<pre style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.4; white-space: pre-wrap; margin: 0; font-family: \'Courier New\', Mono, monospace>';

                const jsonString = JSON.stringify(data, null, 2)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;');
                html += jsonString;

                html += '</pre>';
                html += '</div>';

                document.getElementById('monitorContent').innerHTML = html;

            } catch (error) {
                console.error('Error rendering monitor display:', error);
                document.getElementById('monitorContent').innerHTML =
                    '<div class="alert alert-error">Failed to render monitor data: ' + error.message + '</div>';
            }
        }

        function exportMonitorData() {
            if (!systemData || !Object.keys(systemData).length) {
                showAlert('No monitor data to export. Please refresh first.', 'error');
                return;
            }

            const blob = new Blob([JSON.stringify(systemData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qup-system-variables-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showAlert('System variables exported successfully', 'success');
        }

        function exportQueue() {
            apiCall('/api/v1/queue/list?admin=true')
                .then(response => response.json())
                .then(data => {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `qup-queue-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showAlert('Queue exported successfully', 'success');
                })
                .catch(error => {
                    showAlert('Failed to export queue: ' + error.message, 'error');
                });
        }

        function clearCompleted() {
            if (confirm('Clear all completed orders?')) {
                showAlert('Clear completed functionality coming soon...', 'info');
            }
        }

        async function apiCall(endpoint, options) {
            options = options || {};

            if (!adminKey) {
                throw new Error('Admin key not available');
            }

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                }
            };

            const mergedOptions = { ...defaultOptions, ...options };
            if (options.headers) {
                mergedOptions.headers = { ...defaultOptions.headers, ...options.headers };
            }

            return fetch(API_BASE + endpoint, mergedOptions);
        }

        function showAlert(message, type) {
            type = type || 'info';
            const container = document.getElementById('alertsContainer');
            const alert = document.createElement('div');
            alert.className = 'alert alert-' + type;
            alert.textContent = message;

            container.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function setLoading(type, loading) {
            const text = document.getElementById(type + 'Text');
            const spinner = document.getElementById(type + 'Loading');

            if (loading) {
                text.style.display = 'none';
                spinner.classList.remove('hidden');
            } else {
                text.style.display = 'inline';
                spinner.classList.add('hidden');
            }
        }

        // Global function for queue actions
        window.quickAction = quickAction;

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
