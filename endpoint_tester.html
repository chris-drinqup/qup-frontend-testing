<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUP Local Endpoint Tester</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0f0f23;
            color: #ffffff;
        }
        
        .container {
            background: #262654;
            border-radius: 15px;
            padding: 30px;
            border: 1px solid #3a3a6b;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .endpoint-test {
            background: #1a1a3e;
            border: 1px solid #3a3a6b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .endpoint-title {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .test-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            background: #0f0f23;
            border: 1px solid #3a3a6b;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success { border-color: #10b981; color: #10b981; }
        .error { border-color: #ef4444; color: #ef4444; }
        .warning { border-color: #f59e0b; color: #f59e0b; }
        .info { border-color: #3b82f6; color: #3b82f6; }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-pending { background: #f59e0b; animation: pulse 1.5s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .config-section {
            background: #262654;
            border: 1px solid #3a3a6b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        input, textarea {
            width: 100%;
            padding: 8px 12px;
            background: #0f0f23;
            border: 1px solid #3a3a6b;
            border-radius: 4px;
            color: #ffffff;
            margin-bottom: 10px;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .admin-key-section {
            background: #1a1a3e;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .key-status {
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß QUP Local Endpoint Tester</h1>
        
        <!-- Admin Key Section -->
        <div class="admin-key-section">
            <div class="endpoint-title">üîë Admin Authentication</div>
            <input type="text" id="serverUrl" value="http://localhost:8080" placeholder="Server URL">
            <button class="test-button" onclick="getAdminKey()">Get Admin Key</button>
            <button class="test-button" onclick="clearAdminKey()">Clear Key</button>
            <div class="key-status" id="keyStatus">No admin key</div>
        </div>

        <!-- New Config Endpoints Testing -->
        <div class="endpoint-test">
            <div class="endpoint-title">
                <span class="status-indicator" id="getConfigStatus"></span>
                GET /api/v1/config/get - Get Current Configuration
            </div>
            <button class="test-button" onclick="testGetConfig()">Test GET Config</button>
            <div class="result" id="getConfigResult"></div>
        </div>

        <div class="endpoint-test">
            <div class="endpoint-title">
                <span class="status-indicator" id="updateConfigStatus"></span>
                POST /api/v1/config/update - Update Configuration
            </div>
            <div class="config-section">
                <label style="color: #a5a5c9;">Test Configuration JSON:</label>
                <textarea id="configData" rows="8" placeholder="Enter configuration JSON...">{
  "queue_name": "Test Queue",
  "mode": "super_qup",
  "max_queue_size": 500,
  "default_time_estimate": 90,
  "default_priority": 400,
  "super_qup_enabled": true,
  "max_qup_time": 250
}</textarea>
            </div>
            <button class="test-button" onclick="testUpdateConfig()">Test UPDATE Config</button>
            <div class="result" id="updateConfigResult"></div>
        </div>

        <div class="endpoint-test">
            <div class="endpoint-title">
                <span class="status-indicator" id="resetConfigStatus"></span>
                POST /api/v1/config/reset - Reset to Defaults
            </div>
            <button class="test-button" onclick="testResetConfig()">Test RESET Config</button>
            <button class="test-button" onclick="confirmReset()" style="background: #ef4444;">‚ö†Ô∏è FULL RESET</button>
            <div class="result" id="resetConfigResult"></div>
        </div>

        <!-- Legacy Endpoints for Comparison -->
        <div class="endpoint-test">
            <div class="endpoint-title">
                <span class="status-indicator" id="queueListStatus"></span>
                GET /api/v1/queue/list - Queue List (for comparison)
            </div>
            <button class="test-button" onclick="testQueueList()">Test Queue List</button>
            <div class="result" id="queueListResult"></div>
        </div>

        <div class="endpoint-test">
            <div class="endpoint-title">
                <span class="status-indicator" id="healthStatus"></span>
                GET /health - Health Check
            </div>
            <button class="test-button" onclick="testHealth()">Test Health</button>
            <div class="result" id="healthResult"></div>
        </div>

        <!-- Test All Button -->
        <div style="text-align: center; margin-top: 30px;">
            <button class="test-button" onclick="testAllEndpoints()" style="font-size: 1.1rem; padding: 15px 30px;">
                üöÄ Test All Endpoints
            </button>
        </div>
    </div>

    <script>
        let adminKey = null;
        let serverUrl = 'http://localhost:8080';

        function updateServerUrl() {
            serverUrl = document.getElementById('serverUrl').value;
        }

        function updateStatus(elementId, status) {
            const indicator = document.getElementById(elementId);
            if (indicator) {  // Add null check
                indicator.className = `status-indicator status-${status}`;
            }
        }

        function showResult(elementId, data, success = true) {
            const element = document.getElementById(elementId);
            element.className = `result ${success ? 'success' : 'error'}`;
            
            if (typeof data === 'object') {
                element.textContent = JSON.stringify(data, null, 2);
            } else {
                element.textContent = data;
            }
        }

        async function getAdminKey() {
            updateServerUrl();
            
            try {
                const response = await fetch(`${serverUrl}/api/auth/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.admin_key) {
                    adminKey = data.admin_key;
                    document.getElementById('keyStatus').innerHTML = `‚úÖ Admin key obtained: ${adminKey.substring(0, 20)}...`;
                    document.getElementById('keyStatus').style.color = '#10b981';
                } else {
                    throw new Error(data.error || 'Failed to get admin key');
                }
            } catch (error) {
                document.getElementById('keyStatus').innerHTML = `‚ùå Failed: ${error.message}`;
                document.getElementById('keyStatus').style.color = '#ef4444';
                adminKey = null;
            }
        }

        function clearAdminKey() {
            adminKey = null;
            document.getElementById('keyStatus').innerHTML = 'No admin key';
            document.getElementById('keyStatus').style.color = '#a5a5c9';
        }

        async function apiCall(endpoint, options = {}) {
            if (!adminKey) {
                throw new Error('No admin key available. Please get admin key first.');
            }

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                }
            };

            const mergedOptions = { ...defaultOptions, ...options };
            if (options.headers) {
                mergedOptions.headers = { ...defaultOptions.headers, ...options.headers };
            }

            const response = await fetch(`${serverUrl}${endpoint}`, mergedOptions);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            return response.json();
        }

        async function testGetConfig() {
            updateStatus('getConfigStatus', 'pending');
            
            try {
                const data = await apiCall('/api/v1/config/get');
                updateStatus('getConfigStatus', 'success');
                showResult('getConfigResult', data, true);
            } catch (error) {
                updateStatus('getConfigStatus', 'error');
                showResult('getConfigResult', `Error: ${error.message}`, false);
            }
        }

        async function testUpdateConfig() {
            updateStatus('updateConfigStatus', 'pending');
            
            try {
                const configJson = document.getElementById('configData').value;
                const configData = JSON.parse(configJson);
                
                const data = await apiCall('/api/v1/config/update', {
                    method: 'POST',
                    body: JSON.stringify(configData)
                });
                
                updateStatus('updateConfigStatus', 'success');
                showResult('updateConfigResult', data, true);
            } catch (error) {
                updateStatus('updateConfigStatus', 'error');
                showResult('updateConfigResult', `Error: ${error.message}`, false);
            }
        }

        async function testResetConfig() {
            updateStatus('resetConfigStatus', 'pending');
            
            try {
                const data = await apiCall('/api/v1/config/reset', {
                    method: 'POST'
                });
                
                updateStatus('resetConfigStatus', 'success');
                showResult('resetConfigResult', data, true);
            } catch (error) {
                updateStatus('resetConfigStatus', 'error');
                showResult('resetConfigResult', `Error: ${error.message}`, false);
            }
        }

        function confirmReset() {
            if (confirm('This will reset ALL configuration to defaults. Are you sure?')) {
                testResetConfig();
            }
        }

        async function testQueueList() {
            updateStatus('queueListStatus', 'pending');
            
            try {
                const data = await apiCall('/api/v1/queue/list?admin=true');
                updateStatus('queueListStatus', 'success');
                showResult('queueListResult', data, true);
            } catch (error) {
                updateStatus('queueListStatus', 'error');
                showResult('queueListResult', `Error: ${error.message}`, false);
            }
        }

        async function testHealth() {
            updateStatus('healthStatus', 'pending');
            updateServerUrl();
            
            try {
                const response = await fetch(`${serverUrl}/health`);
                const data = await response.json();
                
                updateStatus('healthStatus', 'success');
                showResult('healthResult', data, true);
            } catch (error) {
                updateStatus('healthStatus', 'error');
                showResult('healthResult', `Error: ${error.message}`, false);
            }
        }

        async function testAllEndpoints() {
            console.log('üöÄ Testing all endpoints...');
            
            // First get admin key
            await getAdminKey();
            
            if (!adminKey) {
                alert('Failed to get admin key. Cannot proceed with testing.');
                return;
            }

            // Wait a bit between tests
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            await testHealth();
            await delay(500);
            
            await testQueueList();
            await delay(500);
            
            await testGetConfig();
            await delay(500);
            
            await testUpdateConfig();
            await delay(500);
            
            console.log('‚úÖ All endpoint tests completed!');
        }

        // Initialize
        document.getElementById('serverUrl').addEventListener('change', updateServerUrl);
    </script>
</body>
</html>
